# Example 03: 简单循环 - 代码调试助手

## 复杂度
⭐⭐ 初级

## 需求

### 背景
实现一个自动化的代码调试助手，能够生成代码、检测错误、自动修复，并通过循环机制不断优化直到代码正确或达到最大重试次数。

### 功能需求

#### 1. 核心流程

**步骤1：代码生成**
- 接收用户的功能描述
- 根据描述生成初始代码
- 支持 Python 语言（可扩展其他语言）

**步骤2：错误检测**
- 对生成的代码进行语法检查
- 检测常见的逻辑错误
- 识别潜在的运行时问题
- 记录所有发现的错误

**步骤3：修复决策**
- 判断是否存在错误
- 如果无错误 → 结束流程
- 如果有错误且未超过最大重试次数 → 进入修复步骤
- 如果达到最大重试次数 → 标记失败并结束

**步骤4：代码修复**
- 根据错误信息生成修复方案
- 应用修复并生成新版本代码
- 记录修复历史
- 返回步骤2继续检查

#### 2. 循环控制
- 最大重试次数：3次
- 每次循环记录：
  - 循环次数
  - 发现的错误
  - 采取的修复措施
  - 修复是否成功

#### 3. 状态管理
需要维护以下状态：
- `task_description`: 任务描述
- `code`: 当前代码版本
- `errors`: 检测到的错误列表
- `retry_count`: 当前重试次数
- `max_retries`: 最大重试次数（默认3）
- `status`: 状态（generating/checking/fixing/success/failed）
- `history`: 修复历史记录

### 技术要求

#### LangGraph 学习点
- 掌握循环的实现方式
- 理解如何使用计数器控制循环次数
- 学习循环终止条件的设置
- 掌握在循环中更新状态
- 理解条件边与循环的结合

#### 实现要点
1. 使用条件边判断是否继续循环
2. 在状态中维护重试计数器
3. 设计明确的循环退出条件
4. 错误检测节点连接回修复节点形成循环
5. 使用历史记录追踪修复过程

### 验收标准

1. **功能完整性**
   - 能够生成符合描述的代码
   - 准确检测代码中的错误
   - 能够修复常见错误
   - 循环控制正确

2. **循环机制**
   - 无错误时正确退出
   - 达到最大次数时正确退出
   - 中间过程能够正确循环

3. **错误处理**
   - 识别语法错误
   - 识别逻辑错误
   - 给出有效的修复建议

4. **输出质量**
   - 显示完整的调试过程
   - 展示每次循环的改进
   - 最终代码可执行

### 示例输入输出

**示例1：一次修复成功**
```
输入: "写一个函数，计算列表中所有数字的平均值"

=== 第1次尝试 ===
生成的代码:
def average(nums):
    return sum(nums) / len(nums)

错误检测: 未处理空列表的情况

=== 第2次尝试（修复后）===
修复的代码:
def average(nums):
    if not nums:
        return 0
    return sum(nums) / len(nums)

错误检测: 无错误
状态: ✅ 成功
总尝试次数: 2
```

**示例2：多次修复**
```
输入: "写一个函数，读取文件并返回行数"

=== 第1次尝试 ===
生成的代码:
def count_lines(filename):
    f = open(filename)
    return len(f.readlines())

错误检测: 
- 文件未关闭
- 未处理文件不存在异常

=== 第2次尝试（修复后）===
修复的代码:
def count_lines(filename):
    try:
        f = open(filename)
        lines = len(f.readlines())
        f.close()
        return lines
    except FileNotFoundError:
        return 0

错误检测: 应该使用 with 语句

=== 第3次尝试（修复后）===
修复的代码:
def count_lines(filename):
    try:
        with open(filename, 'r') as f:
            return len(f.readlines())
    except FileNotFoundError:
        return 0

错误检测: 无错误
状态: ✅ 成功
总尝试次数: 3
```

**示例3：达到最大次数**
```
输入: "写一个复杂的排序算法"

=== 第1次尝试 ===
[生成代码...]
错误检测: 多处逻辑错误

=== 第2次尝试 ===
[修复代码...]
错误检测: 仍存在边界问题

=== 第3次尝试 ===
[再次修复...]
错误检测: 部分测试用例失败

=== 第4次尝试 ===
状态: ❌ 失败（达到最大重试次数3次）
建议: 请简化需求或人工介入修复
```

### 扩展思考

完成基础需求后，可以考虑：
1. 添加单元测试自动生成和执行
2. 支持多种编程语言
3. 实现代码性能优化建议
4. 添加代码风格检查（PEP8等）
5. 支持增量修复（只修改有问题的部分）
6. 添加人工介入点，允许用户指导修复方向
7. 实现代码版本对比展示
