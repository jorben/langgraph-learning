# Example 05: 自适应 RAG 系统

## 复杂度
⭐⭐⭐ 中级

## 需求

### 背景
实现一个智能的检索增强生成（RAG）系统，能够根据问题的特性自适应地决策是否需要检索、如何检索、以及如何处理检索结果。系统具备自我评估和优化能力，确保回答的准确性和相关性。

### 功能需求

#### 1. 核心流程

**步骤1：问题分析**
- 接收用户问题
- 分析问题类型：
  - 事实性问题（需要检索）
  - 常识性问题（可能不需要检索）
  - 实时性问题（需要最新数据）
  - 推理性问题（需要知识+推理）
- 评估问题难度和复杂度
- 提取关键实体和概念

**步骤2：检索决策**
- 判断是否需要进行文档检索
- 场景A：直接回答
  - 简单常识问题
  - LLM 知识范围内的确定性问题
- 场景B：需要检索
  - 专业领域知识
  - 具体事实和数据
  - 最新信息

**步骤3：查询生成与优化**
- 如果需要检索，生成检索查询
- 支持多种查询策略：
  - 单一查询
  - 多角度查询（生成3-5个相关查询）
  - 查询扩展（添加同义词、相关概念）

**步骤4：文档检索**
- 执行向量数据库检索
- 获取 Top-K 相关文档（K=5）
- 记录检索源和相关度分数

**步骤5：相关性评估**
- 评估检索到的文档与问题的相关性
- 对每个文档进行打分（0-10分）
- 判断标准：
  - 8-10分：高度相关，直接使用
  - 5-7分：部分相关，可以使用
  - 0-4分：不相关，需要重新检索

**步骤6：决策分支**
- **如果文档高度相关** → 进入生成回答
- **如果文档部分相关** → 生成回答并标注置信度
- **如果文档不相关** → 进入查询重写流程

**步骤7：查询重写**
- 分析为什么检索失败
- 重新表述查询：
  - 改变关键词
  - 调整查询粒度
  - 拆分复杂问题
- 最多重试2次

**步骤8：答案生成**
- 基于检索文档生成答案
- 标注信息来源
- 计算置信度分数
- 如果置信度低，给出警告

**步骤9：答案验证**
- 检查答案的逻辑一致性
- 验证是否回答了原问题
- 检测幻觉（信息是否真的在文档中）

#### 2. 状态管理
需要维护以下状态：
- `question`: 用户原始问题
- `question_type`: 问题类型
- `need_retrieval`: 是否需要检索（boolean）
- `queries`: 生成的检索查询列表
- `retrieved_docs`: 检索到的文档
- `relevance_scores`: 相关性分数
- `rewrite_count`: 查询重写次数
- `max_rewrites`: 最大重写次数（2次）
- `answer`: 生成的答案
- `confidence`: 置信度分数
- `sources`: 信息来源

### 技术要求

#### LangGraph 学习点
- 掌握复杂的条件分支逻辑
- 理解自适应循环（基于质量评估的循环）
- 学习多层决策树的实现
- 掌握状态的细粒度管理
- 理解回退机制的设计

#### 实现要点
1. 使用多个条件边实现复杂决策
2. 实现评估节点（独立的质量检查）
3. 设计合理的循环退出条件
4. 模拟向量数据库检索（可用简单的文本匹配）
5. 实现查询优化策略

#### 3. 模拟知识库
为了演示，需要创建一个模拟的知识库：
- 包含20-30篇文档
- 涵盖多个主题（科技、历史、医学等）
- 每篇文档200-500字
- 使用简单的 TF-IDF 或相似度匹配模拟检索

### 验收标准

1. **智能决策**
   - 正确判断是否需要检索
   - 检索策略合理
   - 重写逻辑有效

2. **检索质量**
   - 能够找到相关文档
   - 相关性评估准确
   - 查询优化有效果

3. **答案质量**
   - 答案准确且相关
   - 置信度评估合理
   - 信息来源清晰

4. **自适应能力**
   - 能够从失败中恢复
   - 查询重写能改善结果
   - 避免无限循环

### 示例输入输出

**示例1：直接回答（无需检索）**
```
输入: "1+1等于几？"

=== 问题分析 ===
类型: 简单算术问题
需要检索: 否
决策: 直接回答

=== 生成答案 ===
答案: 1+1等于2
置信度: 10/10
来源: 基础数学知识
```

**示例2：一次检索成功**
```
输入: "LangGraph 是什么时候发布的？"

=== 问题分析 ===
类型: 事实性问题
需要检索: 是
复杂度: 中

=== 查询生成 ===
查询: "LangGraph release date"

=== 文档检索 ===
检索到 5 篇文档
Top 1: "LangGraph 官方文档：2024年1月发布..." (相关度: 9.2)

=== 相关性评估 ===
评分: 9.2/10 - 高度相关
决策: 直接生成答案

=== 生成答案 ===
答案: LangGraph 于2024年1月正式发布，是 LangChain 生态系统中用于构建有状态多Agent应用的框架。
置信度: 9.2/10
来源: LangGraph 官方文档
```

**示例3：需要查询重写**
```
输入: "那个用图来做AI应用的框架叫什么？"

=== 第1次尝试 ===
问题分析: 模糊描述，需要检索
查询生成: "AI application graph framework"
文档检索: 5篇文档
相关性评估: 最高相关度 4.5/10 - 不相关
决策: 需要重写查询

=== 第2次尝试（查询重写）===
重写分析: 用户可能指 LangGraph 或类似框架
新查询: "LangGraph AI agent framework graph-based"
文档检索: 5篇文档
相关性评估: 最高相关度 8.8/10 - 高度相关
决策: 生成答案

=== 生成答案 ===
答案: 您描述的可能是 LangGraph，它是一个基于图结构的框架，用于构建复杂的AI Agent应用...
置信度: 8.5/10
来源: LangGraph 技术文档
备注: 基于模糊描述推测，建议确认
```

**示例4：多次重写后降级回答**
```
输入: "最新的那个超级厉害的AI模型叫啥？"

=== 第1次尝试 ===
查询: "latest powerful AI model"
相关性: 3.2/10

=== 第2次尝试（重写）===
查询: "newest AI model 2024 release"
相关性: 4.8/10

=== 第3次尝试（重写）===
查询: "GPT-4 Claude Gemini latest version"
相关性: 5.5/10

=== 达到最大重试次数 ===
答案: 由于问题描述较为模糊，我无法确定您具体指哪个AI模型。2024年发布的主要模型包括：
- GPT-4 Turbo
- Claude 3
- Gemini 1.5
建议您提供更具体的信息以获得准确答案。

置信度: 5/10
备注: 信息不足，建议用户澄清问题
```

### 扩展思考

完成基础需求后，可以考虑：
1. 集成真实的向量数据库（Chroma、Pinecone等）
2. 实现混合检索（向量+关键词+语义）
3. 添加答案引用溯源功能
4. 实现分段检索（针对长文档）
5. 添加多文档对比和融合
6. 实现检索缓存机制
7. 添加用户反馈学习（好评/差评）
8. 支持多轮对话的上下文追踪
9. 实现检索结果的可视化展示
