# Example 08: 反思型 Agent - 研究助手

## 复杂度
⭐⭐⭐⭐⭐ 高级

## 需求

### 背景
实现一个具备自我反思和持续优化能力的研究助手 Agent，采用 ReAct（Reasoning + Acting）模式，能够制定研究计划、执行搜索分析、自我评估质量、反思改进策略，并在多轮迭代中不断提升研究深度和质量。

### 功能需求

#### 1. ReAct 循环架构

```
规划 → 执行 → 观察 → 反思 → 评估 → (继续循环 or 结束)
  ↑                                        ↓
  └────────────── 优化策略 ─────────────────┘
```

#### 2. 核心阶段

**阶段1：任务理解与初步规划**
- **输入**：用户的研究主题/问题
- **处理**：
  - 分析研究主题的复杂度
  - 识别关键概念和子问题
  - 评估需要的信息维度
  - 制定初步研究计划
- **输出**：研究计划 v1.0
  - 研究目标
  - 关键问题列表
  - 信息收集策略
  - 预期产出

**阶段2：执行搜索与分析**
- **工具调用**：
  - 网络搜索（多个关键词）
  - 学术文献检索
  - 数据分析
  - 专家观点收集
- **处理**：
  - 并行执行多个搜索
  - 提取关键信息
  - 识别信息源质量
  - 记录信息来源
- **输出**：
  - 收集的信息集合
  - 信息源列表
  - 初步分析结果

**阶段3：观察与记录**
- **观察维度**：
  - 信息完整性：是否回答了所有关键问题？
  - 信息质量：来源是否可靠？
  - 信息深度：是否足够深入？
  - 信息相关性：是否切题？
  - 发现的新问题：出现了哪些新的研究方向？
- **输出**：观察报告

**阶段4：自我反思**
- **反思维度**：
  - **策略有效性**：当前研究策略是否有效？
  - **信息缺口**：还缺少哪些关键信息？
  - **方向偏差**：是否偏离了研究主题？
  - **深度不足**：哪些方面需要深挖？
  - **新发现**：是否有意外但重要的发现？
- **反思方法**：
  - 对比原始目标与当前进展
  - 识别假设是否被验证
  - 检查逻辑链是否完整
  - 评估证据强度
- **输出**：反思报告
  - 问题诊断
  - 改进建议
  - 新的研究方向

**阶段5：质量评估**
- **评估指标**：
  - 完整性得分（0-10）：是否回答了所有问题
  - 深度得分（0-10）：分析是否深入
  - 可信度得分（0-10）：信息源是否可靠
  - 洞察力得分（0-10）：是否有独特见解
  - 总体得分：加权平均
- **决策阈值**：
  - 得分 ≥ 8.0：研究质量优秀，可以结束
  - 得分 6.0-7.9：质量良好但可改进，根据迭代次数决定
  - 得分 < 6.0：质量不足，必须继续优化
- **输出**：质量报告

**阶段6：策略优化**
- **基于反思调整策略**：
  - 如果信息不完整 → 补充搜索缺失部分
  - 如果深度不够 → 针对性深度研究
  - 如果出现偏差 → 重新聚焦核心问题
  - 如果发现新方向 → 扩展研究范围
- **输出**：优化后的研究计划 v2.0, v3.0...

**阶段7：决策分支**
- **继续研究**：
  - 条件：质量得分 < 8.0 且迭代次数 < 5
  - 行动：返回执行阶段，使用优化后的计划
- **结束研究**：
  - 条件：质量得分 ≥ 8.0 或达到最大迭代次数
  - 行动：生成最终研究报告

**阶段8：生成最终报告**
- **报告结构**：
  - 执行摘要
  - 研究过程回顾
  - 核心发现
  - 详细分析
  - 证据支持
  - 局限性说明
  - 结论与建议
  - 参考资料
- **元信息**：
  - 迭代历史
  - 策略演进
  - 质量提升曲线

#### 3. 状态管理

```python
class ResearchState(TypedDict):
    # 输入
    research_topic: str
    
    # 规划
    research_plan: dict  # 当前研究计划
    plan_version: int  # 计划版本号
    
    # 执行
    search_queries: list  # 搜索查询列表
    collected_info: list  # 收集的信息
    sources: list  # 信息来源
    
    # 观察
    observations: dict  # 观察结果
    
    # 反思
    reflections: list  # 历次反思记录
    identified_gaps: list  # 识别的信息缺口
    
    # 评估
    quality_scores: dict  # 质量评分
    iteration_scores: list  # 历次迭代得分
    
    # 控制
    iteration_count: int  # 当前迭代次数
    max_iterations: int  # 最大迭代次数（5）
    should_continue: bool  # 是否继续
    
    # 输出
    final_report: str  # 最终报告
```

### 技术要求

#### LangGraph 学习点
- 掌握复杂的自循环结构
- 理解 ReAct 模式的实现
- 学习自我评估机制
- 掌握动态策略调整
- 理解元认知在 Agent 中的应用
- 学习多维度质量评估

#### 实现要点

1. **ReAct 提示词设计**：
```
你是一个研究助手，请按照以下格式思考：

Thought: 我现在需要做什么？为什么？
Action: 我要执行的具体行动
Observation: 我观察到的结果
Reflection: 这个结果意味着什么？我的策略是否需要调整？
```

2. **反思机制**：
```python
def reflect(state):
    """自我反思节点"""
    # 对比目标与现状
    # 识别问题
    # 生成改进建议
    return {
        "reflections": [...],
        "identified_gaps": [...],
    }
```

3. **质量评估**：
```python
def evaluate_quality(state):
    """多维度质量评估"""
    scores = {
        "completeness": score_completeness(state),
        "depth": score_depth(state),
        "credibility": score_credibility(state),
        "insight": score_insight(state),
    }
    overall = weighted_average(scores)
    
    should_continue = (
        overall < 8.0 and 
        state["iteration_count"] < state["max_iterations"]
    )
    
    return {
        "quality_scores": scores,
        "should_continue": should_continue
    }
```

### 验收标准

1. **反思能力**
   - 能够识别当前策略的问题
   - 反思内容具体且可操作
   - 能够从失败中学习

2. **自适应能力**
   - 策略能够根据反思调整
   - 后续迭代质量有提升
   - 能够修正错误方向

3. **质量控制**
   - 评估标准合理
   - 能够准确识别质量问题
   - 停止条件合理

4. **研究深度**
   - 最终报告有深度
   - 信息来源可靠
   - 分析有洞察力

### 示例输入输出

**研究主题：量子计算在加密货币中的威胁**

```
==========================================
第 1 轮迭代
==========================================

=== 阶段1: 任务理解与规划 ===
[规划器 Planner]

📋 研究计划 v1.0

研究目标:
评估量子计算对加密货币安全性的威胁程度和时间表

关键问题:
1. 量子计算的当前发展水平
2. 加密货币使用的加密算法
3. 量子计算破解这些算法需要的条件
4. 可能的时间线
5. 行业的应对措施

信息收集策略:
- 搜索量子计算最新进展
- 了解加密货币加密机制
- 查找专家预测和评估

---

=== 阶段2: 执行搜索 ===
[执行器 Executor]

🔍 执行搜索...

查询1: "quantum computing current state 2024"
结果: 找到5篇相关资料，包括Google量子优势声明...

查询2: "cryptocurrency encryption algorithms"  
结果: Bitcoin使用SHA-256和ECDSA，以太坊使用Keccak-256...

查询3: "quantum threat to cryptography timeline"
结果: NIST预测大规模量子计算机可能在2030-2040年出现...

收集信息: 15条
信息源: 8个（学术论文3篇，新闻5篇）

---

=== 阶段3: 观察 ===
[观察者 Observer]

👁️ 观察报告:

信息完整性: 中等
- ✅ 已回答: 量子计算现状、加密算法
- ❌ 缺失: 具体攻击路径、行业应对细节

信息质量: 良好
- 来源包括NIST、学术论文
- 部分信息来自新闻，需要验证

信息深度: 浅
- 多为概述性信息
- 缺少技术细节

新发现:
- 后量子密码学(PQC)标准化进程已开始

---

=== 阶段4: 自我反思 ===
[反思者 Reflector]

🤔 反思报告:

策略有效性: 部分有效
- 成功获得基础信息
- 但查询过于宽泛，导致深度不足

信息缺口:
1. ❌ 缺少具体的量子比特数量要求
2. ❌ 缺少破解时间的数学估算
3. ❌ 缺少行业具体应对案例
4. ❌ 缺少后量子密码学的技术细节

改进建议:
1. 针对性搜索："SHA-256 quantum attack requirements"
2. 深度搜索："post-quantum cryptography NIST standards"
3. 案例搜索："blockchain quantum resistance solutions"

方向正确性: ✅ 正确
未发现偏离主题

---

=== 阶段5: 质量评估 ===
[评估器 Evaluator]

📊 质量评分:

- 完整性: 5/10（缺少关键技术细节）
- 深度: 4/10（停留在表面）
- 可信度: 7/10（来源较可靠）
- 洞察力: 3/10（缺乏独特见解）

📈 总体得分: 4.75/10

决策: ⚠️ 质量不足，必须继续研究
原因: 多项指标低于6分，缺少核心技术细节

---

=== 阶段6: 策略优化 ===
[优化器 Optimizer]

📋 研究计划 v2.0

基于反思的调整:
1. 精确查询关键技术参数
2. 增加学术来源比例
3. 搜索实际案例和解决方案

新的搜索查询:
- "SHA-256 quantum bits required"
- "Grover's algorithm Bitcoin"
- "post-quantum blockchain projects"
- "quantum resistant cryptocurrencies"

==========================================
第 2 轮迭代  
==========================================

=== 执行搜索 ===
[执行器 Executor]

🔍 执行优化后的搜索...

查询: "SHA-256 quantum bits required"
结果: 找到学术论文，指出需要约10^9量子比特...

查询: "Grover's algorithm Bitcoin"
结果: Grover算法可将SHA-256暴力破解从2^256降到2^128...

查询: "post-quantum blockchain"
结果: QAN、IOTA等项目正在开发抗量子区块链...

新增信息: 12条（8条来自学术论文）

---

=== 观察 ===
信息完整性: 高
- ✅ 现在有具体技术参数
- ✅ 有攻击路径分析
- ✅ 有应对方案案例

信息深度: 中等偏上
- 包含数学估算
- 有技术实现细节

---

=== 反思 ===
策略有效性: ✅ 有效
- 优化后的查询获得了高质量信息
- 学术来源增加

剩余缺口:
- 可以补充更多行业专家观点
- 时间线预测可以更详细

---

=== 质量评估 ===
- 完整性: 8/10
- 深度: 7/10
- 可信度: 9/10
- 洞察力: 6/10

总体得分: 7.5/10

决策: 🤔 质量良好，考虑继续优化
迭代次数: 2/5，继续一轮

==========================================
第 3 轮迭代
==========================================

[经过第3轮优化后...]

=== 质量评估 ===
- 完整性: 9/10
- 深度: 8/10
- 可信度: 9/10
- 洞察力: 8/10

总体得分: 8.5/10 ✅

决策: ✅ 质量优秀，可以生成最终报告

==========================================
最终研究报告
==========================================

📄 量子计算对加密货币威胁的深度分析

【执行摘要】
量子计算对加密货币构成长期威胁，但短期内（10年内）风险较低。
行业已开始积极应对，后量子密码学标准化正在推进。

【研究过程】
- 总迭代次数: 3轮
- 查询执行: 15次
- 信息来源: 20个（学术论文12篇，行业报告8篇）
- 质量提升: 4.75 → 7.5 → 8.5

【核心发现】

1. 量子计算现状（2024）
   - Google: 105量子比特（Willow芯片）
   - IBM: 433量子比特（Osprey）
   - 破解SHA-256需要: ~10^9量子比特（相差6个数量级）

2. 攻击路径分析
   威胁等级: 中等（长期）
   
   场景A：攻击公钥加密（ECDSA）
   - Shor算法可有效破解
   - 需要约4000个逻辑量子比特
   - 预计时间: 2030-2035年
   - 影响: 高（可伪造交易）
   
   场景B：攻击哈希函数（SHA-256）
   - Grover算法效率提升有限
   - 需要约10^9量子比特
   - 预计时间: 2040年后
   - 影响: 中（挖矿优势）

3. 时间线预测
   - 2025-2028: 量子计算继续发展，威胁理论化
   - 2028-2032: ECDSA开始面临实际威胁
   - 2032-2035: 需要迁移到后量子密码
   - 2035+: SHA-256可能需要加强

4. 行业应对措施
   ✅ 标准化进程:
      - NIST已发布PQC标准（2024）
      - 包括CRYSTALS-Kyber、CRYSTALS-Dilithium等
   
   ✅ 项目实践:
      - QAN: 原生抗量子区块链
      - IOTA: 使用Winternitz签名
      - 以太坊: 研究迁移方案
   
   ✅ 升级路径:
      - 软分叉升级签名算法
      - 混合密码体系（过渡方案）

【结论】
1. 威胁真实但非迫在眉睫
2. 有充足时间准备（5-10年窗口）
3. 技术解决方案已经存在
4. 需要社区协调升级

【建议】
- 短期(1-3年): 监控量子计算进展
- 中期(3-7年): 开始测试PQC实现  
- 长期(7-10年): 完成协议升级

【局限性】
- 量子计算发展速度难以精确预测
- 部分专家观点存在分歧
- 新的量子算法可能改变时间线

【参考资料】
[1] NIST Post-Quantum Cryptography Standardization (2024)
[2] Aggarwal et al. "Quantum attacks on Bitcoin" (2017)
[3] Google Quantum AI, Willow Chip Announcement (2024)
[... 共20个引用]

==========================================
研究元信息
==========================================

📈 迭代改进历程:

第1轮: 4.75分 - 信息过于宽泛，缺少细节
第2轮: 7.50分 - 补充技术参数，深度提升
第3轮: 8.50分 - 增加专家观点，完善时间线

策略演进:
v1.0: 宽泛搜索 → 获得概览
v2.0: 精确搜索 → 获得技术细节
v3.0: 专家观点 → 增加洞察

总耗时: 约25分钟
总查询: 15次
反思次数: 3次
```

### 扩展思考

完成基础需求后，可以考虑：
1. 添加知识图谱构建（连接概念）
2. 实现多假设并行验证
3. 添加可视化研究路径图
4. 实现协作研究（多Agent分工）
5. 添加持续学习机制（从历史研究中学习）
6. 实现证据链追踪
7. 添加反驳观点搜索（避免确认偏见）
8. 实现自动生成研究论文
9. 添加同行评审模拟
10. 支持增量研究（基于已有报告深化）
