# Example 09: 分层规划 Agent - 旅行规划师

## 复杂度
⭐⭐⭐⭐⭐ 专家级

## 需求

### 背景
实现一个三层架构的智能旅行规划系统，采用分层规划（Hierarchical Planning）模式。高层负责战略规划，中层负责战术执行，底层负责具体操作。各层之间有清晰的职责划分和双向反馈机制，底层失败会影响高层重新规划。

### 功能需求

#### 1. 三层架构设计

```
┌─────────────────────────────────────────┐
│   高层：战略规划层（Strategic Layer）    │
│   职责：目的地选择、总体行程安排         │
│   时间跨度：整个旅程（7-14天）           │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│   中层：战术执行层（Tactical Layer）     │
│   职责：每日详细规划、交通安排           │
│   时间跨度：单日（24小时）               │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│   底层：操作执行层（Operational Layer）  │
│   职责：具体预订、工具调用               │
│   时间跨度：单个操作（分钟级）           │
└─────────────────────────────────────────┘
```

#### 2. 各层详细职责

**高层：战略规划 Agent**

输入：
- 旅行需求（目的地偏好、时间、预算、人数）
- 约束条件（签证、季节、特殊需求）

职责：
1. 目的地选择与优先级排序
2. 总体行程框架设计
3. 预算分配策略
4. 风险评估与备选方案

输出：
- 战略计划文档
  - 主要目的地列表
  - 行程天数分配
  - 预算分配方案
  - 必游景点清单

决策示例：
```
需求: "2周时间，预算3万，想去日本"
战略决策:
- 目的地: 东京(4天) → 京都(3天) → 大阪(3天) → 北海道(4天)
- 预算分配: 交通30%、住宿30%、餐饮20%、景点门票10%、其他10%
- 关键景点: 富士山、清水寺、道顿堀、札幌雪祭
```

---

**中层：战术执行 Agent**

输入：
- 高层的战略计划
- 当前所在城市
- 当天可用时间

职责：
1. 将战略目标分解为当日任务
2. 优化景点游览顺序
3. 规划城际和城内交通
4. 餐饮和休息时间安排
5. 处理时间冲突

输出：
- 战术执行计划（每日行程表）
  - 小时级时间表
  - 景点顺序
  - 交通方式和时刻
  - 用餐安排

决策示例：
```
输入: "东京第1天，游览富士山和浅草寺"
战术规划:
07:00-08:00 酒店早餐
08:00-09:30 前往新宿站，乘坐富士回游号
09:30-13:00 富士山五合目游览、午餐
13:00-15:30 返回东京
15:30-16:00 前往浅草
16:00-18:00 浅草寺、仲见世商店街
18:00-19:30 晚餐（浅草附近寿司店）
19:30-20:30 返回酒店
```

---

**底层：操作执行 Agent**

输入：
- 中层的具体任务指令
- 操作参数（航班号、酒店名称等）

职责：
1. 调用真实API完成预订
   - 航班预订
   - 酒店预订
   - 景点门票
   - 餐厅预约
2. 处理预订失败
3. 返回确认信息

输出：
- 预订确认结果
- 失败原因（如果失败）

工具调用示例：
```python
# 底层工具集
tools = [
    search_flights(),      # 搜索航班
    book_flight(),         # 预订航班
    search_hotels(),       # 搜索酒店
    book_hotel(),          # 预订酒店
    get_attraction_info(), # 获取景点信息
    book_tickets(),        # 预订门票
    search_restaurants(),  # 搜索餐厅
    make_reservation(),    # 预约餐厅
    get_weather(),         # 查询天气
    calculate_route(),     # 规划路线
]
```

#### 3. 跨层反馈机制

**向上反馈（Bottom-up Feedback）**

场景1：底层预订失败
```
底层: 无法预订首选酒店（已满）
  ↓ 反馈
中层: 选择备选酒店 or 调整住宿位置
  ↓ 如果所有备选都不可行
高层: 重新规划该城市的停留天数或更换城市
```

场景2：交通延误
```
底层: 检测到航班延误3小时
  ↓ 反馈
中层: 取消当天下午景点，调整为次日
  ↓ 如果影响连锁行程
高层: 压缩其他城市天数，或取消某个次要目的地
```

场景3：预算超支
```
底层: 累计预订金额超出预算20%
  ↓ 反馈
中层: 选择经济型餐饮和交通
  ↓ 如果仍然超支
高层: 缩短行程天数或降低住宿标准
```

**向下分解（Top-down Decomposition）**

```
高层计划: "游览京都3天"
  ↓ 分解给中层
  
中层规划:
  Day 1: 东部（清水寺、祗园）
  Day 2: 北部（金阁寺、龙安寺）
  Day 3: 西部（岚山、天龙寺）
  ↓ 分解给底层
  
底层执行:
  - 预订Day 1 清水寺门票 ✅
  - 预订Day 1 祗园餐厅 ✅
  - 预订Day 2 金阁寺门票 ❌ 维修关闭！
  ↓ 反馈失败
  
中层调整:
  Day 2: 改为银阁寺 + 哲学之道
  ↓ 重新下发
  
底层重试:
  - 预订银阁寺门票 ✅
```

#### 4. SubGraph 实现

**高层图（Main Graph）**
```python
high_level = StateGraph(HighLevelState)
high_level.add_node("analyze_requirements", analyze_node)
high_level.add_node("select_destinations", select_node)
high_level.add_node("allocate_budget", budget_node)
high_level.add_node("mid_level_planning", mid_level_subgraph)  # SubGraph!
high_level.add_node("evaluate_plan", evaluate_node)
```

**中层图（SubGraph）**
```python
mid_level = StateGraph(MidLevelState)
mid_level.add_node("daily_planning", daily_plan_node)
mid_level.add_node("optimize_route", route_node)
mid_level.add_node("low_level_execution", low_level_subgraph)  # SubGraph!
mid_level.add_node("handle_conflicts", conflict_node)
```

**底层图（SubGraph）**
```python
low_level = StateGraph(LowLevelState)
low_level.add_node("tool_selector", select_tool_node)
low_level.add_node("execute_tool", execute_node)
low_level.add_node("verify_result", verify_node)
```

#### 5. 状态管理

**高层状态**
```python
class HighLevelState(TypedDict):
    user_requirements: dict
    destinations: list
    duration_per_destination: dict
    budget_allocation: dict
    strategic_plan: dict
    overall_status: str
    feedback_from_mid: list  # 中层反馈
```

**中层状态**
```python
class MidLevelState(TypedDict):
    strategic_plan: dict  # 继承自高层
    current_city: str
    daily_schedule: dict
    transportation_plan: dict
    tactical_status: str
    feedback_from_low: list  # 底层反馈
    escalate_to_high: bool  # 是否需要上报高层
```

**底层状态**
```python
class LowLevelState(TypedDict):
    task: dict  # 中层下发的任务
    tool_name: str
    tool_params: dict
    execution_result: dict
    success: bool
    error_message: str
```

### 技术要求

#### LangGraph 学习点
- **核心：掌握 SubGraph 的创建和嵌套**
- 理解跨层状态传递
- 学习向上反馈的异常处理
- 掌握多层决策的协调
- 理解状态的层级隔离与共享
- 学习复杂系统的分层设计原则

#### 实现要点

1. **创建 SubGraph**：
```python
# 底层子图
low_level_graph = create_low_level_graph()
low_level_subgraph = low_level_graph.compile()

# 中层子图（包含底层）
mid_level_graph = create_mid_level_graph()
mid_level_graph.add_node("low_level", low_level_subgraph)
mid_level_subgraph = mid_level_graph.compile()

# 高层主图（包含中层）
high_level_graph = create_high_level_graph()
high_level_graph.add_node("mid_level", mid_level_subgraph)
app = high_level_graph.compile()
```

2. **状态映射**：
```python
# 高层传递给中层时的状态映射
def map_high_to_mid(high_state):
    return {
        "strategic_plan": high_state["strategic_plan"],
        "current_city": high_state["destinations"][0],
        # ... 其他需要的字段
    }
```

3. **异常上报**：
```python
def handle_low_level_failure(state):
    if state["critical_failure"]:
        # 上报到高层重新规划
        return {"escalate_to_high": True}
    else:
        # 中层自己处理
        return {"try_alternative": True}
```

### 验收标准

1. **分层清晰**
   - 三层职责明确
   - 没有跨层越界
   - 状态隔离合理

2. **反馈机制**
   - 底层失败能正确上报
   - 中层能处理常规问题
   - 高层能应对重大变更

3. **协调能力**
   - 各层决策协调一致
   - 冲突能够合理解决
   - 全局最优而非局部最优

4. **健壮性**
   - 单点失败不影响整体
   - 有合理的备选方案
   - 能够优雅降级

### 示例输入输出

**完整流程演示**

```
==========================================
输入需求
==========================================
旅行者: 李先生
需求:
- 目的地偏好: 日本
- 时间: 10天
- 预算: 25,000元
- 人数: 2人
- 兴趣: 文化历史、美食
- 特殊要求: 避免过度劳累

==========================================
高层：战略规划
==========================================

[分析需求]
✓ 时间充足，可以覆盖2-3个城市
✓ 预算中等，人均12,500元
✓ 偏好文化，建议京都、奈良
✓ 也需要体验现代日本，建议东京

[选择目的地]
战略决策:
1. 东京 - 4天（现代+购物）
2. 京都 - 3天（古都文化）
3. 奈良 - 1天（世界遗产）
4. 大阪 - 2天（美食+购物）

[预算分配]
- 国际机票: 6,000元（24%）
- 日本国内交通: 3,000元（12%）
- 住宿: 7,500元（30%）
- 餐饮: 5,000元（20%）
- 景点门票: 2,000元（8%）
- 其他: 1,500元（6%）

战略计划已生成，传递给中层...

==========================================
中层：东京 Day 1 战术规划
==========================================

[接收高层指令]
任务: 规划东京第1天行程
重点: 适应时差，轻松游览

[生成每日计划]
⏰ 东京 Day 1 行程:

08:00-09:00 酒店早餐，调整时差
09:00-10:00 前往浅草
10:00-12:00 浅草寺、仲见世商店街
12:00-13:30 午餐：浅草寿司餐厅
13:30-14:30 前往晴空塔
14:30-17:00 晴空塔观景+购物
17:00-18:00 前往银座
18:00-20:00 银座晚餐+漫步
20:00-21:00 返回酒店

[交通规划]
- 使用Tokyo Metro一日券（¥600）
- 路线: 酒店 → 浅草(银座线) → 押上(浅草线) → 银座(日比谷线)

计划已生成，传递给底层执行...

==========================================
底层：操作执行
==========================================

[任务1: 预订浅草寺门票]
🔧 调用工具: book_attraction_ticket()
参数: {"attraction": "浅草寺", "date": "2024-12-15", "count": 2}
结果: ✅ 免费景点，无需预订

[任务2: 预订浅草餐厅]
🔧 调用工具: search_restaurants()
参数: {"location": "浅草", "cuisine": "寿司", "price": "中等"}
结果: 找到3家餐厅

🔧 调用工具: make_reservation()
参数: {"restaurant": "大江户寿司", "date": "2024-12-15", "time": "12:00", "people": 2}
结果: ✅ 预订成功，确认号: R20241215-001

[任务3: 预订晴空塔门票]
🔧 调用工具: book_attraction_ticket()
参数: {"attraction": "东京晴空塔", "date": "2024-12-15", "time": "14:30", "count": 2}
结果: ❌ 失败！该时段已售罄

⚠️ 检测到失败，向上反馈...

==========================================
中层：处理底层反馈
==========================================

[接收失败通知]
问题: 晴空塔14:30时段售罄

[评估影响]
严重程度: 中等（可调整）
影响范围: 仅影响下午行程

[生成备选方案]
方案A: 改为16:00时段
方案B: 改去东京塔
方案C: 取消高塔参观，增加其他景点

[执行调整]
选择方案A，尝试16:00时段

向下重新下发任务...

==========================================
底层：重试执行
==========================================

[任务3 重试: 预订晴空塔门票]
🔧 调用工具: book_attraction_ticket()
参数: {"attraction": "东京晴空塔", "date": "2024-12-15", "time": "16:00", "count": 2}
结果: ✅ 预订成功！票号: TKY-2024-8821, 8822

✅ 所有任务完成

向上反馈: Day 1 执行成功，有小幅调整

==========================================
中层：继续其他天规划
==========================================

[Day 2, Day 3, Day 4 依次规划和执行...]

==========================================
中层：京都 Day 5 - 严重问题
==========================================

[底层执行报告]
❌ 严重失败：
- 首选酒店: 满房
- 备选酒店A: 满房
- 备选酒店B: 满房
- 原因: 京都祗园祭期间，全城酒店爆满

⚠️ 问题严重，上报高层！

==========================================
高层：处理重大问题
==========================================

[接收中层上报]
问题: 京都酒店全部订满，无法按原计划停留3天

[重新评估]
严重程度: 高
影响: 整个战略计划需要调整

[生成新战略]
方案A: 缩短京都至1天（当日往返）
方案B: 改住大阪，每天往返京都
方案C: 延后京都行程至下周

[决策]
选择方案B: 
- 在大阪预订酒店3晚
- 白天坐JR往返京都（30分钟）
- 成本增加但可保留游览计划

✅ 新战略计划生成

[更新预算]
- 交通预算增加: +800元
- 住宿预算调整: -500元（大阪比京都便宜）
- 净增加: +300元（在可接受范围内）

新战略下发中层重新执行...

==========================================
中层：执行新战略
==========================================

[Day 5 新计划]
基地: 大阪酒店
行程: 大阪 → 京都（清水寺、祗园）→ 大阪
交通: JR Pass

[底层执行]
✅ 大阪酒店预订成功
✅ JR车票预订成功  
✅ 京都景点门票成功

Day 5-7 顺利执行

==========================================
最终交付
==========================================

📋 完整旅行计划书

【行程概览】
东京 4天 → 京都/大阪 4天 → 大阪 2天
总计: 10天9晚

【详细行程】
[每日时刻表，共10天]
[交通安排]
[酒店确认]
[餐厅预订]
[景点门票]

【预算执行】
计划预算: 25,000元
实际预算: 25,300元
超支: 300元（1.2%，可接受）

【调整记录】
1. Day 1: 晴空塔时间调整（14:30→16:00）
2. Day 5-7: 京都住宿问题，改住大阪往返

【确认信息】
- 航班: ✅ 已确认
- 酒店: ✅ 9晚全部确认
- JR Pass: ✅ 已预订
- 景点门票: ✅ 8个景点已预订
- 餐厅: ✅ 6家餐厅已预约

【应急联系】
- 高层协调员: [联系方式]
- 中层执行者: [联系方式]
- 底层客服: [24小时热线]

状态: ✅ 计划完成，可以出发！
```

### 扩展思考

完成基础需求后，可以考虑：
1. 添加更多层级（4层、5层架构）
2. 实现动态优先级调整
3. 添加机器学习优化（从历史规划中学习）
4. 实现多Agent并行规划（不同城市同时规划）
5. 添加实时监控和动态调整（旅行中修改计划）
6. 实现社交功能（参考其他旅行者的计划）
7. 添加个性化推荐引擎
8. 实现成本优化算法（最小化总成本）
9. 添加风险预测和保险建议
10. 支持多目的地复杂行程（环球旅行）
