# Example 04: 多工具调用 - 个人助理

## 复杂度
⭐⭐⭐ 中级

## 需求

### 背景
实现一个智能个人助理系统，能够理解用户的自然语言指令，自动选择和调用合适的工具（天气查询、日历管理、邮件发送、网络搜索等），并整合多个工具的结果返回给用户。

### 功能需求

#### 1. 工具集成

系统需要集成以下工具：

**工具1：天气查询**
- 功能：查询指定城市的天气信息
- 输入：城市名称
- 输出：温度、天气状况、湿度、风力等

**工具2：日历管理**
- 功能：查询日程、添加事件、删除事件
- 输入：操作类型、日期、事件详情
- 输出：操作结果或日程列表

**工具3：邮件发送**
- 功能：发送邮件
- 输入：收件人、主题、内容
- 输出：发送状态

**工具4：网络搜索**
- 功能：搜索网络信息
- 输入：搜索关键词
- 输出：搜索结果摘要

**工具5：计算器**
- 功能：执行数学计算
- 输入：数学表达式
- 输出：计算结果

**工具6：时间查询**
- 功能：查询当前时间或时区转换
- 输入：时区（可选）
- 输出：时间信息

#### 2. 核心流程

**步骤1：指令理解**
- 接收用户的自然语言指令
- 使用 LLM 解析用户意图
- 识别需要调用的工具（可能是多个）
- 提取每个工具所需的参数

**步骤2：工具选择**
- 根据意图分析结果选择工具
- 支持单工具调用
- 支持多工具串行调用
- 支持多工具并行调用

**步骤3：工具执行**
- 使用 LangGraph 的 `ToolExecutor` 执行工具
- 处理工具执行的异常
- 记录执行结果
- 如果工具调用失败，生成友好的错误提示

**步骤4：结果整合**
- 收集所有工具的执行结果
- 使用 LLM 将结果整合成自然语言
- 生成结构化的回复

**步骤5：继续判断**
- 判断是否需要调用更多工具
- 如果用户指令完成 → 结束
- 如果需要更多信息 → 继续工具调用循环

#### 3. 状态管理
需要维护以下状态：
- `user_input`: 用户原始输入
- `intent`: 识别的用户意图
- `tools_to_call`: 需要调用的工具列表
- `tool_results`: 工具执行结果
- `messages`: 对话消息历史
- `iteration_count`: 迭代次数（防止无限循环）
- `final_response`: 最终回复

### 技术要求

#### LangGraph 学习点
- 掌握 `ToolExecutor` 的使用
- 理解工具的定义和注册
- 学习工具调用的循环模式
- 掌握 Agent 与 Tools 之间的交互
- 理解如何将 LangChain 工具集成到 LangGraph

#### 实现要点
1. 定义工具函数并添加装饰器
2. 创建 `ToolExecutor` 实例
3. Agent 节点负责决策
4. Tools 节点负责执行
5. 使用条件边判断是否继续调用工具
6. 最大迭代次数设为5次，防止无限循环

### 验收标准

1. **工具集成**
   - 所有6个工具正常工作
   - 工具可以被正确调用
   - 参数传递准确

2. **智能决策**
   - 能够根据指令选择正确的工具
   - 支持多工具组合调用
   - 能够处理模糊指令

3. **结果质量**
   - 工具结果准确
   - 最终回复自然流畅
   - 错误处理友好

4. **性能**
   - 避免不必要的工具调用
   - 合理控制迭代次数

### 示例输入输出

**示例1：单工具调用**
```
输入: "北京今天天气怎么样？"

执行流程:
1. 意图识别: 查询天气
2. 选择工具: weather_query
3. 工具参数: {"city": "北京"}
4. 执行结果: {"temperature": 15, "condition": "晴", "humidity": 45}
5. 整合回复: "北京今天天气晴朗，温度15℃，湿度45%，适合外出活动。"
```

**示例2：多工具串行调用**
```
输入: "搜索'人工智能最新进展'，然后把结果发邮件给 zhang@example.com"

执行流程:
1. 意图识别: 搜索 + 发送邮件
2. 第一次工具调用: web_search
   - 参数: {"query": "人工智能最新进展"}
   - 结果: "AI在医疗、教育领域取得突破..."
3. 第二次工具调用: send_email
   - 参数: {"to": "zhang@example.com", "subject": "人工智能最新进展", "body": "[搜索结果]"}
   - 结果: "邮件发送成功"
4. 整合回复: "我已经搜索了'人工智能最新进展'的相关信息，并将结果发送到 zhang@example.com 了。"
```

**示例3：多工具组合调用**
```
输入: "明天早上9点提醒我开会，顺便告诉我明天上海的天气"

执行流程:
1. 意图识别: 添加日程 + 查询天气
2. 并行调用工具:
   - calendar_add: {"date": "明天", "time": "09:00", "event": "开会"}
   - weather_query: {"city": "上海", "date": "明天"}
3. 工具结果:
   - 日历: "已添加提醒"
   - 天气: "上海明天多云，20-25℃"
4. 整合回复: "好的，我已经在日历中添加了明天早上9点的开会提醒。另外，上海明天天气多云，温度在20-25℃之间。"
```

**示例4：复杂组合**
```
输入: "帮我算一下 1234 * 5678，然后搜索这个数字的含义，最后把结果记录到今天的日程里"

执行流程:
1. 计算器: 1234 * 5678 = 7006652
2. 网络搜索: "7006652 含义"
3. 日历添加: 记录计算结果
4. 整合所有结果返回
```

### 扩展思考

完成基础需求后，可以考虑：
1. 添加更多工具（翻译、图片生成、数据分析等）
2. 实现工具调用的优先级和依赖关系
3. 添加用户偏好学习（常用工具推荐）
4. 实现工具调用的成本估算
5. 支持工具调用的撤销和重试
6. 添加工具执行的可视化流程图
7. 实现多轮对话中的上下文记忆
8. 添加敏感操作的确认机制（如发送邮件前确认）
